# Docker Compose for local development and testing
# Run with: docker-compose up
#
# This simulates the Azure Container Apps deployment locally
# Access the UI at: http://localhost:5173
# Access the API at: http://localhost:8080

version: '3.8'

services:
  # Backend API service
  fabric-api:
    build:
      context: ..
      dockerfile: scripts/docker/Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Server configuration
      - GIN_MODE=release

      # AI Provider credentials (set these in .env file or environment)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    restart: unless-stopped

  # Web UI service (development mode)
  fabric-web:
    build:
      context: ../web
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    environment:
      - FABRIC_BASE_URL=http://fabric-api:8080
    depends_on:
      fabric-api:
        condition: service_healthy
    restart: unless-stopped

# Production setup with Nginx reverse proxy
# Uncomment below for production-like setup with single entry point
#
# nginx:
#   image: nginx:alpine
#   ports:
#     - "80:80"
#   volumes:
#     - ./nginx.conf:/etc/nginx/nginx.conf:ro
#   depends_on:
#     - fabric-api
#     - fabric-web
