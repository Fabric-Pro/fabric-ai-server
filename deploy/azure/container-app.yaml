# =============================================================================
# Azure Container Apps Deployment Configuration
# =============================================================================
# Deploy with: az containerapp create --yaml container-app.yaml
#
# Prerequisites:
# 1. Azure Container Registry with the fabric image
# 2. Azure Key Vault with API keys stored as secrets
# 3. Container Apps Environment created
# =============================================================================

name: fabric-ai
type: Microsoft.App/containerApps
location: eastus  # Change to your preferred region

properties:
  managedEnvironmentId: /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.App/managedEnvironments/<ENVIRONMENT_NAME>

  configuration:
    # Ingress configuration
    ingress:
      external: true
      targetPort: 8080
      transport: auto
      allowInsecure: false
      traffic:
        - latestRevision: true
          weight: 100

    # Container registry authentication
    registries:
      - server: <YOUR_ACR>.azurecr.io
        identity: system
        # Or use username/password:
        # username: <username>
        # passwordSecretRef: acr-password

    # Secrets (reference from Azure Key Vault or set directly)
    secrets:
      - name: openai-api-key
        keyVaultUrl: https://<YOUR_KEYVAULT>.vault.azure.net/secrets/OPENAI-API-KEY
        identity: system
      - name: anthropic-api-key
        keyVaultUrl: https://<YOUR_KEYVAULT>.vault.azure.net/secrets/ANTHROPIC-API-KEY
        identity: system
      - name: gemini-api-key
        keyVaultUrl: https://<YOUR_KEYVAULT>.vault.azure.net/secrets/GEMINI-API-KEY
        identity: system
      # Add more secrets as needed

  template:
    containers:
      - name: fabric
        image: <YOUR_ACR>.azurecr.io/fabric:latest
        resources:
          cpu: 0.5
          memory: 1Gi

        # Environment variables
        env:
          # Server configuration
          - name: GIN_MODE
            value: release

          # API Key for Fabric REST API (optional, for securing the API)
          # - name: FABRIC_API_KEY
          #   secretRef: fabric-api-key

          # AI Provider credentials from Key Vault secrets
          - name: OPENAI_API_KEY
            secretRef: openai-api-key
          - name: ANTHROPIC_API_KEY
            secretRef: anthropic-api-key
          - name: GEMINI_API_KEY
            secretRef: gemini-api-key

          # Optional: Custom patterns directory (mount from Azure Files)
          # - name: CUSTOM_PATTERNS_DIRECTORY
          #   value: /mnt/custom-patterns

        # Health probes
        probes:
          - type: Liveness
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 30
            failureThreshold: 3

          - type: Readiness
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 3
            periodSeconds: 10
            failureThreshold: 3

          - type: Startup
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 0
            periodSeconds: 5
            failureThreshold: 30

    # Scaling configuration
    scale:
      minReplicas: 1
      maxReplicas: 10
      rules:
        - name: http-scaling
          http:
            metadata:
              concurrentRequests: "50"

        # Optional: Scale based on CPU
        # - name: cpu-scaling
        #   custom:
        #     type: cpu
        #     metadata:
        #       type: Utilization
        #       value: "70"

  # Identity for accessing Key Vault and Container Registry
  identity:
    type: SystemAssigned
